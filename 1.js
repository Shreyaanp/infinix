import{Settings$1 as e,ParsedURL$1 as t,ResourceType$1 as n,resourceTypes as s,ObjectWrapper$1 as i,Console$1 as r,removeEventListeners as o,Throttler$1 as a,CharacterIdMap$1 as d,Trie$1 as l,reveal as c}from"../../core/common/common.js";import{InspectorFrontendHostInstance as h,isWin as u,userMetrics as m,Action as p,Events as f,isMac as g}from"../../core/host/host.js";import{EmptyRawPathString as S,trimMiddle as y,Multimap as w,naturalOrderComparator as F,intersectOrdered as v,hashCode as C,EmptyUrlString as P,EmptyEncodedPathString as I,escapeCharacters as x,reverse as b}from"../../core/platform/platform.js";import{TargetManager$1 as k,MultitargetNetworkManager as E,Type as U,Resource$1 as T}from"../../core/sdk/sdk.js";import{NetworkProject$1 as R}from"../bindings/bindings.js";import{ProjectStore as L,projectTypes as j,UISourceCodeMetadata as M,Events as A,WorkspaceImpl as B,Events$1 as W,UISourceCode$1 as N,FileManager$1 as O}from"../workspace/workspace.js";import{experiments as _,ExperimentName as q}from"../../core/root/root.js";import{performSearchInContent as H}from"../text_utils/text_utils.js";import{registerUIStrings as D,getLocalizedString as $}from"../../core/i18n/i18n.js";import{LinkDecorator as z,Linkifier$1 as V}from"../../ui/legacy/components/utils/utils.js";import{Icon$1 as G,Tooltip$1 as J,VBox as Y,createTextButton as K,ListWidget$1 as Q,Editor as X,createTextChild as Z,createInput as ee,bindLabelToControl as te,bindInput as ne,markAsHeading as se,Toolbar$1 as ie,ToolbarButton as re,createSettingCheckbox as oe}from"../../ui/legacy/legacy.js";const ae={unableToReadFilesWithThis:"`PlatformFileSystem` cannot read files."},de=D("models/persistence/PlatformFileSystem.ts",ae),le=$.bind(void 0,de);class ce{pathInternal;typeInternal;constructor(e,t){this.pathInternal=e,this.typeInternal=t}getMetadata(e){return Promise.resolve(null)}initialFilePaths(){return[]}initialGitFolders(){return[]}path(){return this.pathInternal}embedderPath(){throw new Error("Not implemented")}type(){return this.typeInternal}async createFile(e,t){return Promise.resolve(null)}deleteFile(e){return Promise.resolve(!1)}requestFileBlob(e){return Promise.resolve(null)}async requestFileContent(e){return{content:null,error:le(ae.unableToReadFilesWithThis),isEncoded:!1}}setFileContent(e,t,n){throw new Error("Not implemented")}renameFile(e,t,n){n(!1)}addExcludedFolder(e){}removeExcludedFolder(e){}fileSystemRemoved(){}isFileExcluded(e){return!1}excludedFolders(){return new Set}searchInPath(e,t){return Promise.resolve([])}indexContent(e){queueMicrotask((()=>{e.done()}))}mimeFromPath(e){throw new Error("Not implemented")}canExcludeFolder(e){return!1}contentType(e){throw new Error("Not implemented")}tooltipForURL(e){throw new Error("Not implemented")}supportsAutomapping(){throw new Error("Not implemented")}}var he=Object.freeze({__proto__:null,PlatformFileSystem:ce});const ue={fileSystemErrorS:"File system error: {PH1}",blobCouldNotBeLoaded:"Blob could not be loaded.",cantReadFileSS:"Can't read file: {PH1}: {PH2}",unknownErrorReadingFileS:"Unknown error reading file: {PH1}",linkedToS:"Linked to {PH1}"},me=D("models/persistence/IsolatedFileSystem.ts",ue),pe=$.bind(void 0,me);class fe extends ce{manager;embedderPathInternal;domFileSystem;excludedFoldersSetting;excludedFoldersInternal;excludedEmbedderFolders;initialFilePathsInternal;initialGitFoldersInternal;fileLocks;constructor(t,n,s,i,r){super(n,r),this.manager=t,this.embedderPathInternal=s,this.domFileSystem=i,this.excludedFoldersSetting=e.instance().createLocalSetting("workspaceExcludedFolders",{}),this.excludedFoldersInternal=new Set(this.excludedFoldersSetting.get()[n]||[]),this.excludedEmbedderFolders=[],this.initialFilePathsInternal=new Set,this.initialGitFoldersInternal=new Set,this.fileLocks=new Map}static async create(e,t,n,s,i,r){const o=h.isolatedFileSystem(i,r);if(!o)return null;const a=new fe(e,t,n,o,s);return a.initializeFilePaths().then((()=>a)).catch((e=>(console.error(e),null)))}static errorMessage(e){return pe(ue.fileSystemErrorS,{PH1:e.message})}serializedFileOperation(e,t){const n=Promise.resolve(this.fileLocks.get(e)).then((()=>t.call(null)));return this.fileLocks.set(e,n),n}getMetadata(e){let n;const s=new Promise((e=>{n=e}));return this.domFileSystem.root.getFile(t.encodedPathToRawPathString(e),void 0,(function(e){e.getMetadata(n,i)}),i),s;function i(t){const s=fe.errorMessage(t);console.error(s+" when getting file metadata '"+e),n(null)}}initialFilePaths(){return[...this.initialFilePathsInternal]}initialGitFolders(){return[...this.initialGitFoldersInternal]}embedderPath(){return this.embedderPathInternal}initializeFilePaths(){return new Promise((e=>{let n=1;const s=function(i){for(let e=0;e<i.length;++e){const r=i[e];if(r.isDirectory){if(r.fullPath.endsWith("/.git")){const e=r.fullPath.lastIndexOf("/"),n=t.substr(r.fullPath,1,e);this.initialGitFoldersInternal.add(t.rawPathToEncodedPathString(n))}if(this.isFileExcluded(t.concatenate(t.rawPathToEncodedPathString(r.fullPath),"/"))){const e=t.concatenate(this.path(),t.rawPathToEncodedPathString(r.fullPath));this.excludedEmbedderFolders.push(t.urlToRawPathString(e,u()));continue}++n,this.requestEntries(r.fullPath,s)}else{if(this.isFileExcluded(t.rawPathToEncodedPathString(r.fullPath)))continue;this.initialFilePathsInternal.add(t.rawPathToEncodedPathString(t.substr(r.fullPath,1)))}}0==--n&&e()}.bind(this);this.requestEntries(S,s)}))}async createFoldersIfNotExist(e){let t=await new Promise((t=>this.domFileSystem.root.getDirectory(e,void 0,t,(()=>t(null)))));if(t)return t;const n=e.split("/");let s="";for(const e of n)if(s=s+"/"+e,t=await this.innerCreateFolderIfNeeded(s),!t)return null;return t}innerCreateFolderIfNeeded(e){return new Promise((t=>{this.domFileSystem.root.getDirectory(e,{create:!0},(e=>t(e)),(n=>{const s=fe.errorMessage(n);console.error(s+" trying to create directory '"+e+"'"),t(null)}))}))}async createFile(e,n){const s=await this.createFoldersIfNotExist(t.encodedPathToRawPathString(e));if(!s)return null;const i=await this.serializedFileOperation(e,function n(i,r){return new Promise((o=>{const a=t.concatenate(i,(r||"").toString());s.getFile(a,{create:!0,exclusive:!0},o,(t=>{if("InvalidModificationError"===t.name)return void o(n.call(this,i,r?r+1:1));const s=fe.errorMessage(t);console.error(s+" when testing if file exists '"+this.path()+"/"+e+"/"+a+"'"),o(null)}))}))}.bind(this,n||"NewFile"));return i?t.rawPathToEncodedPathString(t.substr(i.fullPath,1)):null}deleteFile(e){let n;const s=new Promise((e=>{n=e}));return this.domFileSystem.root.getFile(t.encodedPathToRawPathString(e),void 0,function(e){e.remove(i,r.bind(this))}.bind(this),r.bind(this)),s;function i(){n(!0)}function r(t){const s=fe.errorMessage(t);console.error(s+" when deleting file '"+this.path()+"/"+e+"'"),n(!1)}}requestFileBlob(e){return new Promise((n=>{function s(t){if("NotFoundError"===t.name)return void n(null);const s=fe.errorMessage(t);console.error(s+" when getting content for file '"+this.path()+"/"+e+"'"),n(null)}this.domFileSystem.root.getFile(t.encodedPathToRawPathString(e),void 0,(e=>{e.file(n,s.bind(this))}),s.bind(this))}))}requestFileContent(e){return this.serializedFileOperation(e,(()=>this.innerRequestFileContent(e)))}async innerRequestFileContent(e){const n=await this.requestFileBlob(e);if(!n)return{content:null,error:pe(ue.blobCouldNotBeLoaded),isEncoded:!1};const s=new FileReader,i=t.extractExtension(e),r=Fe.has(i),o=new Promise((e=>{s.onloadend=e}));if(r?s.readAsBinaryString(n):s.readAsText(n),await o,s.error){const t=pe(ue.cantReadFileSS,{PH1:e,PH2:s.error.toString()});return console.error(t),{content:null,isEncoded:!1,error:t}}let a=null,d=null;try{a=s.result}catch(t){a=null,d=pe(ue.cantReadFileSS,{PH1:e,PH2:t.message})}return null==a?(d=d||pe(ue.unknownErrorReadingFileS,{PH1:e}),console.error(d),{content:null,isEncoded:!1,error:d}):{isEncoded:r,content:r?btoa(a):a}}async setFileContent(e,n,s){let i;m.actionTaken(p.FileSavedInWorkspace);function r(e){e.createWriter(o.bind(this),a.bind(this))}async function o(e){let t;e.onerror=a.bind(this),e.onwriteend=function(){e.onwriteend=i,e.truncate(t.size)},t=s?await(await fetch(`data:application/octet-stream;base64,${n}`)).blob():new Blob([n],{type:"text/plain"}),e.write(t)}function a(t){const n=fe.errorMessage(t);console.error(n+" when setting content for file '"+this.path()+"/"+e+"'"),i(void 0)}this.serializedFileOperation(e,(()=>{const n=new Promise((e=>{i=e}));return this.domFileSystem.root.getFile(t.encodedPathToRawPathString(e),{create:!0},r.bind(this),a.bind(this)),n}))}renameFile(e,n,s){if(!(n=n?t.trim(n):n)||-1!==n.indexOf("/"))return void s(!1);let i,r;function o(e){r=e,r.getFile(n,void 0,a,d.bind(this))}function a(e){s(!1)}function d(e){"NotFoundError"===e.name?i.moveTo(r,n,l,c.bind(this)):s(!1)}function l(e){s(!0,e.name)}function c(t){const i=fe.errorMessage(t);console.error(i+" when renaming file '"+this.path()+"/"+e+"' to '"+n+"'"),s(!1)}this.domFileSystem.root.getFile(t.encodedPathToRawPathString(e),void 0,function(e){if(e.name===n)return void s(!1);i=e,i.getParent(o.bind(this),c.bind(this))}.bind(this),c.bind(this))}readDirectory(e,t){const n=e.createReader();let s=[];function i(n){const s=fe.errorMessage(n);console.error(s+" when reading directory '"+e.fullPath+"'"),t([])}n.readEntries((function e(r){var o;r.length?(s=s.concat((o=r,Array.prototype.slice.call(o||[],0))),n.readEntries(e,i)):t(s.sort())}),i)}requestEntries(e,t){this.domFileSystem.root.getDirectory(e,void 0,function(e){this.readDirectory(e,t)}.bind(this),(function(n){const s=fe.errorMessage(n);console.error(s+" when requesting entry '"+e+"'"),t([])}))}saveExcludedFolders(){const e=this.excludedFoldersSetting.get();e[this.path()]=[...this.excludedFoldersInternal],this.excludedFoldersSetting.set(e)}addExcludedFolder(e){this.excludedFoldersInternal.add(e),this.saveExcludedFolders(),this.manager.dispatchEventToListeners(ke.ExcludedFolderAdded,e)}removeExcludedFolder(e){this.excludedFoldersInternal.delete(e),this.saveExcludedFolders(),this.manager.dispatchEventToListeners(ke.ExcludedFolderRemoved,e)}fileSystemRemoved(){const e=this.excludedFoldersSetting.get();delete e[this.path()],this.excludedFoldersSetting.set(e)}isFileExcluded(e){if(this.excludedFoldersInternal.has(e))return!0;const n=this.manager.workspaceFolderExcludePatternSetting().asRegExp();return Boolean(n&&n.test(t.encodedPathToRawPathString(e)))}excludedFolders(){return this.excludedFoldersInternal}searchInPath(e,n){return new Promise((s=>{const i=this.manager.registerCallback((function(e){s(e.map((e=>t.rawPathToUrlString(e)))),n.incrementWorked(1)}));h.searchInPath(i,this.embedderPathInternal,e)}))}indexContent(e){e.setTotalWork(1);const t=this.manager.registerProgress(e);h.indexPath(t,this.embedderPathInternal,JSON.stringify(this.excludedEmbedderFolders))}mimeFromPath(e){return n.mimeFromURL(e)||"text/plain"}canExcludeFolder(e){return Boolean(e)&&"overrides"!==this.type()}contentType(e){const n=t.extractExtension(e);return ge.has(n)?s.Stylesheet:Se.has(n)?s.Document:we.has(n)?s.Image:ye.has(n)?s.Script:Fe.has(n)?s.Other:s.Document}tooltipForURL(e){const n=y(t.urlToRawPathString(e,u()),150);return pe(ue.linkedToS,{PH1:n})}supportsAutomapping(){return"overrides"!==this.type()}}const ge=new Set(["css","scss","sass","less"]),Se=new Set(["htm","html","asp","aspx","phtml","jsp"]),ye=new Set(["asp","aspx","c","cc","cljs","coffee","cpp","cs","dart","java","js","jsp","jsx","h","m","mjs","mm","py","sh","ts","tsx","ls"]),we=new Set(["jpeg","jpg","svg","gif","webp","png","ico","tiff","tif","bmp"]),Fe=new Set(["cmd","com","exe","a","ar","iso","tar","bz2","gz","lz","lzma","z","7z","apk","arc","cab","dmg","jar","pak","rar","zip","3gp","aac","aiff","flac","m4a","mmf","mp3","ogg","oga","raw","sln","wav","wma","webm","mkv","flv","vob","ogv","gifv","avi","mov","qt","mp4","m4p","m4v","mpg","mpeg","jpeg","jpg","gif","webp","png","ico","tiff","tif","bmp"]);var ve=Object.freeze({__proto__:null,IsolatedFileSystem:fe,BinaryExtensions:Fe});const Ce={unableToAddFilesystemS:"Unable to add filesystem: {PH1}"},Pe=D("models/persistence/IsolatedFileSystemManager.ts",Ce),Ie=$.bind(void 0,Pe);let xe;class be extends i{fileSystemsInternal;callbacks;progresses;workspaceFolderExcludePatternSettingInternal;fileSystemRequestResolve;fileSystemsLoadedPromise;constructor(){super(),this.fileSystemsInternal=new Map,this.callbacks=new Map,this.progresses=new Map,h.events.addEventListener(f.FileSystemRemoved,this.onFileSystemRemoved,this),h.events.addEventListener(f.FileSystemAdded,(e=>{this.onFileSystemAdded(e)}),this),h.events.addEventListener(f.FileSystemFilesChangedAddedRemoved,this.onFileSystemFilesChanged,this),h.events.addEventListener(f.IndexingTotalWorkCalculated,this.onIndexingTotalWorkCalculated,this),h.events.addEventListener(f.IndexingWorked,this.onIndexingWorked,this),h.events.addEventListener(f.IndexingDone,this.onIndexingDone,this),h.events.addEventListener(f.SearchCompleted,this.onSearchCompleted,this);const t=["/Thumbs.db$","/ehthumbs.db$","/Desktop.ini$","/\\$RECYCLE.BIN/"],n=["/\\.DS_Store$","/\\.Trashes$","/\\.Spotlight-V100$","/\\.AppleDouble$","/\\.LSOverride$","/Icon$","/\\._.*$"],s=["/.*~$"];let i=["/node_modules/","/bower_components/","/\\.devtools","/\\.git/","/\\.sass-cache/","/\\.hg/","/\\.idea/","/\\.svn/","/\\.cache/","/\\.project/"];i=u()?i.concat(t):g()?i.concat(n):i.concat(s);const r=i.join("|");this.workspaceFolderExcludePatternSettingInternal=e.instance().createRegExpSetting("workspaceFolderExcludePattern",r,u()?"i":""),this.fileSystemRequestResolve=null,this.fileSystemsLoadedPromise=this.requestFileSystems()}static instance(e={forceNew:null}){const{forceNew:t}=e;return xe&&!t||(xe=new be),xe}requestFileSystems(){let e;const t=new Promise((t=>{e=t}));return h.events.addEventListener(f.FileSystemsLoaded,(function(e){const t=e.data,s=[];for(let e=0;e<t.length;++e)s.push(this.innerAddFileSystem(t[e],!1));Promise.all(s).then(n)}),this),h.requestFileSystems(),t;function n(t){e(t.filter((e=>Boolean(e))))}}addFileSystem(e){return new Promise((t=>{this.fileSystemRequestResolve=t,h.addFileSystem(e||"")}))}removeFileSystem(e){h.removeFileSystem(e.embedderPath())}waitForFileSystems(){return this.fileSystemsLoadedPromise}innerAddFileSystem(e,n){const s=e.fileSystemPath,i=t.rawPathToUrlString(e.fileSystemPath);return fe.create(this,i,s,e.type,e.fileSystemName,e.rootURL).then(function(e){if(!e)return null;this.fileSystemsInternal.set(i,e),n&&this.dispatchEventToListeners(ke.FileSystemAdded,e);return e}.bind(this))}addPlatformFileSystem(e,t){this.fileSystemsInternal.set(e,t),this.dispatchEventToListeners(ke.FileSystemAdded,t)}onFileSystemAdded(e){const{errorMessage:t,fileSystem:n}=e.data;if(t){if("<selection cancelled>"!==t&&r.instance().error(Ie(Ce.unableToAddFilesystemS,{PH1:t})),!this.fileSystemRequestResolve)return;this.fileSystemRequestResolve.call(null,null),this.fileSystemRequestResolve=null}else n&&this.innerAddFileSystem(n,!0).then((e=>{this.fileSystemRequestResolve&&(this.fileSystemRequestResolve.call(null,e),this.fileSystemRequestResolve=null)}))}onFileSystemRemoved(e){const n=e.data,s=t.rawPathToUrlString(n),i=this.fileSystemsInternal.get(s);i&&(this.fileSystemsInternal.delete(s),i.fileSystemRemoved(),this.dispatchEventToListeners(ke.FileSystemRemoved,i))}onFileSystemFilesChanged(e){const n={changed:s.call(this,e.data.changed),added:s.call(this,e.data.added),removed:s.call(this,e.data.removed)};function s(e){const n=new w;for(const s of e){const e=t.rawPathToUrlString(s);for(const i of this.fileSystemsInternal.keys()){const r=this.fileSystemsInternal.get(i);if(r&&r.isFileExcluded(t.rawPathToEncodedPathString(s)))continue;const o=i.endsWith("/")?i:i+"/";e.startsWith(o)&&n.set(i,e)}}return n}this.dispatchEventToListeners(ke.FileSystemFilesChanged,n)}fileSystems(){return[...this.fileSystemsInternal.values()]}fileSystem(e){return this.fileSystemsInternal.get(e)||null}workspaceFolderExcludePatternSetting(){return this.workspaceFolderExcludePatternSettingInternal}registerCallback(e){const t=++Ee;return this.callbacks.set(t,e),t}registerProgress(e){const t=++Ee;return this.progresses.set(t,e),t}onIndexingTotalWorkCalculated(e){const{requestId:t,totalWork:n}=e.data,s=this.progresses.get(t);s&&s.setTotalWork(n)}onIndexingWorked(e){const{requestId:t,worked:n}=e.data,s=this.progresses.get(t);s&&(s.incrementWorked(n),s.isCanceled()&&(h.stopIndexing(t),this.onIndexingDone(e)))}onIndexingDone(e){const{requestId:t}=e.data,n=this.progresses.get(t);n&&(n.done(),this.progresses.delete(t))}onSearchCompleted(e){const{requestId:t,files:n}=e.data,s=this.callbacks.get(t);s&&(s.call(null,n),this.callbacks.delete(t))}}var ke;!function(e){e.FileSystemAdded="FileSystemAdded",e.FileSystemRemoved="FileSystemRemoved",e.FileSystemFilesChanged="FileSystemFilesChanged",e.ExcludedFolderAdded="ExcludedFolderAdded",e.ExcludedFolderRemoved="ExcludedFolderRemoved"}(ke||(ke={}));let Ee=0;var Ue=Object.freeze({__proto__:null,IsolatedFileSystemManager:be,get Events(){return ke}});const Te={};class Re{isolatedFileSystemManager;workspace;eventListeners;boundFileSystems;constructor(e,t){this.isolatedFileSystemManager=e,this.workspace=t,this.eventListeners=[this.isolatedFileSystemManager.addEventListener(ke.FileSystemAdded,this.onFileSystemAdded,this),this.isolatedFileSystemManager.addEventListener(ke.FileSystemRemoved,this.onFileSystemRemoved,this),this.isolatedFileSystemManager.addEventListener(ke.FileSystemFilesChanged,this.fileSystemFilesChanged,this)],this.boundFileSystems=new Map,this.isolatedFileSystemManager.waitForFileSystems().then(this.onFileSystemsLoaded.bind(this))}static projectId(e){return e}static relativePath(e){const n=e.project().fileSystemBaseURL;return t.split(t.sliceUrlToEncodedPathString(e.url(),n.length),"/")}static tooltipForUISourceCode(e){return e.project().fileSystemInternal.tooltipForURL(e.url())}static fileSystemType(e){return e.fileSystemInternal.type()}static fileSystemSupportsAutomapping(e){return e.fileSystemInternal.supportsAutomapping()}static completeURL(e,n){const s=e;return t.concatenate(s.fileSystemBaseURL,n)}static fileSystemPath(e){return e}fileSystemManager(){return this.isolatedFileSystemManager}onFileSystemsLoaded(e){for(const t of e)this.addFileSystem(t)}onFileSystemAdded(e){const t=e.data;this.addFileSystem(t)}addFileSystem(e){const t=new Te.FileSystem(this,e,this.workspace);this.boundFileSystems.set(e.path(),t)}onFileSystemRemoved(e){const t=e.data,n=this.boundFileSystems.get(t.path());n&&n.dispose(),this.boundFileSystems.delete(t.path())}fileSystemFilesChanged(e){const t=e.data;for(const e of t.changed.keysArray()){const n=this.boundFileSystems.get(e);n&&t.changed.get(e).forEach((e=>n.fileChanged(e)))}for(const e of t.added.keysArray()){const n=this.boundFileSystems.get(e);n&&t.added.get(e).forEach((e=>n.fileChanged(e)))}for(const e of t.removed.keysArray()){const n=this.boundFileSystems.get(e);n&&t.removed.get(e).forEach((e=>n.removeUISourceCode(e)))}}dispose(){o(this.eventListeners);for(const e of this.boundFileSystems.values())e.dispose(),this.boundFileSystems.delete(e.fileSystemInternal.path())}}class Le extends L{fileSystemInternal;fileSystemBaseURL;fileSystemParentURL;fileSystemWorkspaceBinding;fileSystemPathInternal;creatingFilesGuard;constructor(e,n,s){const i=n.path(),r=Re.projectId(i);console.assert(!s.project(r));const o=i.substr(i.lastIndexOf("/")+1);super(s,r,j.FileSystem,o),this.fileSystemInternal=n,this.fileSystemBaseURL=t.concatenate(this.fileSystemInternal.path(),"/"),this.fileSystemParentURL=t.substr(this.fileSystemBaseURL,0,i.lastIndexOf("/")+1),this.fileSystemWorkspaceBinding=e,this.fileSystemPathInternal=i,this.creatingFilesGuard=new Set,s.addProject(this),this.populate()}fileSystemPath(){return this.fileSystemPathInternal}fileSystem(){return this.fileSystemInternal}mimeType(e){return this.fileSystemInternal.mimeFromPath(e.url())}initialGitFolders(){return this.fileSystemInternal.initialGitFolders().map((e=>t.concatenate(this.fileSystemPathInternal,"/",e)))}filePathForUISourceCode(e){return t.sliceUrlToEncodedPathString(e.url(),this.fileSystemPathInternal.length)}isServiceProject(){return!1}requestMetadata(e){const t=je.get(e);if(t)return t;const n=this.filePathForUISourceCode(e),s=this.fileSystemInternal.getMetadata(n).then((function(e){if(!e)return null;return new M(e.modificationTime,e.size)}));return je.set(e,s),s}requestFileBlob(e){return this.fileSystemInternal.requestFileBlob(this.filePathForUISourceCode(e))}requestFileContent(e){const t=this.filePathForUISourceCode(e);return this.fileSystemInternal.requestFileContent(t)}canSetFileContent(){return!0}async setFileContent(e,t,n){const s=this.filePathForUISourceCode(e);await this.fileSystemInternal.setFileContent(s,t,n)}fullDisplayName(e){const t=e.project().fileSystemParentURL;return e.url().substring(t.length)}canRename(){return!0}rename(e,n,s){if(n===e.name())return void s(!0,e.name(),e.url(),e.contentType());let i=this.filePathForUISourceCode(e);this.fileSystemInternal.renameFile(i,n,function(n,r){if(!n||!r)return void s(!1,r);console.assert(Boolean(r));const o=i.lastIndexOf("/"),a=t.substr(i,0,o);i=t.encodedFromParentPathAndName(a,r),i=t.substr(i,1);const d=t.concatenate(this.fileSystemBaseURL,i),l=this.fileSystemInternal.contentType(r);this.renameUISourceCode(e,r),s(!0,r,d,l)}.bind(this))}async searchInFileContent(e,t,n,s){const i=this.filePathForUISourceCode(e),{content:r}=await this.fileSystemInternal.requestFileContent(i);return r?H(r,t,n,s):[]}async findFilesMatchingSearchRequest(e,t,n){let s=t;const i=e.queries().slice();i.length||i.push(""),n.setTotalWork(i.length);for(const t of i){const i=await this.fileSystemInternal.searchInPath(e.isRegex()?"":t,n);i.sort(F),s=v(s,i,F),n.incrementWorked(1)}return n.done(),s}indexContent(e){this.fileSystemInternal.indexContent(e)}populate(){const e=this.fileSystemInternal.initialFilePaths();(function t(n){const s=Math.min(n+1e3,e.length);for(let t=n;t<s;++t)this.addFile(e[t]);s<e.length&&window.setTimeout(t.bind(this,s),100)}).call(this,0)}excludeFolder(e){let n=t.sliceUrlToEncodedPathString(e,this.fileSystemBaseURL.length);n.startsWith("/")||(n=t.prepend("/",n)),n.endsWith("/")||(n=t.concatenate(n,"/")),this.fileSystemInternal.addExcludedFolder(n);const s=this.uiSourceCodes().slice();for(let t=0;t<s.length;++t){const n=s[t];n.url().startsWith(e)&&this.removeUISourceCode(n.url())}}canExcludeFolder(e){return this.fileSystemInternal.canExcludeFolder(e)}canCreateFile(){return!0}async createFile(e,t,n,s){const i=this.fileSystemPathInternal+e+(e.endsWith("/")?"":"/")+t;this.creatingFilesGuard.add(i);const r=await this.fileSystemInternal.createFile(e,t);if(!r)return null;const o=this.addFile(r);return o.setContent(n,Boolean(s)),this.creatingFilesGuard.delete(i),o}deleteFile(e){const t=this.filePathForUISourceCode(e);this.fileSystemInternal.deleteFile(t).then((t=>{t&&this.removeUISourceCode(e.url())}))}remove(){this.fileSystemWorkspaceBinding.isolatedFileSystemManager.removeFileSystem(this.fileSystemInternal)}addFile(e){const n=this.fileSystemInternal.contentType(e),s=this.createUISourceCode(t.concatenate(this.fileSystemBaseURL,e),n);return this.addUISourceCode(s),s}fileChanged(e){if(this.creatingFilesGuard.has(e))return;const t=this.uiSourceCodeForURL(e);if(t)je.delete(t),t.checkContentUpdated();else{const t=this.fileSystemInternal.contentType(e);this.addUISourceCode(this.createUISourceCode(e,t))}}tooltipForURL(e){return this.fileSystemInternal.tooltipForURL(e)}dispose(){this.removeProject()}}Te.FileSystem=Le;const je=new WeakMap;class Me extends Le{async setFileContent(t,n,s){_.isEnabled(q.EDGE_OPEN_VSCODE)&&!e.instance().moduleSetting("enableFileSync").get()||await super.setFileContent(t,n,s)}}Te.FileSystem=Me;var Ae=Object.freeze({__proto__:null,FileSystem:Me,__scope:Te,FileSystemWorkspaceBinding:Re});let Be;class We extends i{bindings;originalResponseContentPromises;savingForOverrides;savingSymbol;enabledSetting;workspace;networkUISourceCodeForEncodedPath;interceptionHandlerBound;updateInterceptionThrottler;projectInternal;activeProject;activeInternal;enabled;eventDescriptors;#e=new Map;constructor(t){super(),this.bindings=new WeakMap,this.originalResponseContentPromises=new WeakMap,this.savingForOverrides=new WeakSet,this.savingSymbol=Symbol("SavingForOverrides"),this.enabledSetting=e.instance().moduleSetting("persistenceNetworkOverridesEnabled"),this.enabledSetting.addChangeListener(this.enabledChanged,this),this.workspace=t,this.networkUISourceCodeForEncodedPath=new Map,this.interceptionHandlerBound=this.interceptionHandler.bind(this),this.updateInterceptionThrottler=new a(50),this.projectInternal=null,this.activeProject=null,this.activeInternal=!1,this.enabled=!1,this.workspace.addEventListener(A.ProjectAdded,(e=>{this.onProjectAdded(e.data)})),this.workspace.addEventListener(A.ProjectRemoved,(e=>{this.onProjectRemoved(e.data)})),Xe.instance().addNetworkInterceptor(this.canHandleNetworkUISourceCode.bind(this)),this.eventDescriptors=[],this.enabledChanged(),k.instance().observeTargets(this)}targetAdded(){this.updateActiveProject()}targetRemoved(){this.updateActiveProject()}static instance(e={forceNew:null,workspace:null}){const{forceNew:t,workspace:n}=e;if(!Be||t){if(!n)throw new Error("Missing workspace for NetworkPersistenceManager");Be=new We(n)}return Be}active(){return this.activeInternal}project(){return this.projectInternal}originalContentForUISourceCode(e){const t=this.bindings.get(e);if(!t)return null;const n=t.fileSystem;return this.originalResponseContentPromises.get(n)||null}async enabledChanged(){this.enabled!==this.enabledSetting.get()&&(this.enabled=this.enabledSetting.get(),this.enabled?(this.eventDescriptors=[B.instance().addEventListener(A.UISourceCodeRenamed,(e=>{this.uiSourceCodeRenamedListener(e)})),B.instance().addEventListener(A.UISourceCodeAdded,(e=>{this.uiSourceCodeAdded(e)})),B.instance().addEventListener(A.UISourceCodeRemoved,(e=>{this.uiSourceCodeRemovedListener(e)})),B.instance().addEventListener(A.WorkingCopyCommitted,(e=>this.onUISourceCodeWorkingCopyCommitted(e.data.uiSourceCode)))],await this.updateActiveProject()):(o(this.eventDescriptors),await this.updateActiveProject()))}async uiSourceCodeRenamedListener(e){const t=e.data.uiSourceCode;await this.onUISourceCodeRemoved(t),await this.onUISourceCodeAdded(t)}async uiSourceCodeRemovedListener(e){await this.onUISourceCodeRemoved(e.data)}async uiSourceCodeAdded(e){await this.onUISourceCodeAdded(e.data)}async updateActiveProject(){const e=this.activeInternal;if(this.activeInternal=Boolean(this.enabledSetting.get()&&k.instance().mainTarget()&&this.projectInternal),this.activeInternal!==e){if(this.activeInternal&&this.projectInternal){await Promise.all(this.projectInternal.uiSourceCodes().map((e=>this.filesystemUISourceCodeAdded(e))));const e=this.workspace.projectsForType(j.Network);for(const t of e)await Promise.all(t.uiSourceCodes().map((e=>this.networkUISourceCodeAdded(e))))}else this.projectInternal&&(await Promise.all(this.projectInternal.uiSourceCodes().map((e=>this.filesystemUISourceCodeRemoved(e)))),this.networkUISourceCodeForEncodedPath.clear());Xe.instance().refreshAutomapping()}}encodedPathFromUrl(e,n){return t.rawPathToEncodedPathString(this.rawPathFromUrl(e,n))}rawPathFromUrl(e,n){if(!this.activeInternal&&!n||!this.projectInternal)return S;let s=t.urlWithoutHash(e.replace(/^https?:\/\//,""));s.endsWith("/")&&-1===s.indexOf("?")&&(s=t.concatenate(s,"index.html"));let i=function(e){const n=[];for(const s of function(e){const n=(e=t.urlWithoutHash(e)).indexOf("?");if(-1===n)return e.split("/");if(0===n)return[e];const s=e.substr(n),i=e.substr(0,e.length-s.length).split("/");return i[i.length-1]+=s,i}(e)){if(!s)continue;let e=encodeURI(s).replace(/[\/\*]/g,(e=>"%"+e[0].charCodeAt(0).toString(16).toUpperCase()));if(u()){e=e.replace(/[:\?]/g,(e=>"%"+e[0].charCodeAt(0).toString(16).toUpperCase())),Ne.has(e.toLowerCase())&&(e=e.split("").map((e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())).join(""));"."===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)+"%2E")}n.push(e)}return n}(s);const r=Re.fileSystemPath(this.projectInternal.id()),o=i.join("/");if(r.length+o.length>200){const e=i[0],n=i[i.length-1],r=n?n.substr(0,10)+"-":"",a=t.extractExtension(s),d=a?"."+a.substr(0,10):"";i=[e,"longurls",r+C(o).toString(16)+d]}return t.join(i,"/")}fileUrlFromNetworkUrl(e,n){return this.projectInternal?t.concatenate(this.projectInternal.fileSystemPath(),"/",this.encodedPathFromUrl(e,n)):P}getHeadersUISourceCodeFromUrl(e){const n=this.fileUrlFromNetworkUrl(e,!0),s=t.substring(n,0,n.lastIndexOf("/")),i=t.concatenate(s,"/",Oe);return B.instance().uiSourceCodeForURL(i)}async getOrCreateHeadersUISourceCodeFromUrl(e){let n=this.getHeadersUISourceCodeFromUrl(e);if(!n&&this.projectInternal){const s=this.encodedPathFromUrl(e,!0),i=t.substring(s,0,s.lastIndexOf("/"));n=await this.projectInternal.createFile(i,Oe,"")}return n}decodeLocalPathToUrlPath(e){try{return unescape(e)}catch(e){console.error(e)}return e}async unbind(e){const t=this.bindings.get(e);t&&(this.bindings.delete(t.network),this.bindings.delete(t.fileSystem),await Xe.instance().removeBinding(t))}async bind(e,t){this.bindings.has(e)&&await this.unbind(e),this.bindings.has(t)&&await this.unbind(t);const n=new lt(e,t);this.bindings.set(e,n),this.bindings.set(t,n),await Xe.instance().addBinding(n);const s=this.savingForOverrides.has(e)?e:t,[{content:i},r]=await Promise.all([s.requestContent(),s.contentEncoded()]);Xe.instance().syncContent(s,i||"",r)}onUISourceCodeWorkingCopyCommitted(e){this.saveUISourceCodeForOverrides(e)}canSaveUISourceCodeForOverrides(e){return this.activeInternal&&e.project().type()===j.Network&&!this.bindings.has(e)&&!this.savingForOverrides.has(e)}async saveUISourceCodeForOverrides(e){if(!this.canSaveUISourceCodeForOverrides(e))return;this.savingForOverrides.add(e);let n=this.encodedPathFromUrl(e.url());const s=(await e.requestContent()).content||"",i=await e.contentEncoded(),r=n.lastIndexOf("/"),o=t.substring(n,r+1),a=t.encodedPathToRawPathString(o);n=t.substr(n,0,r),this.projectInternal&&await this.projectInternal.createFile(n,a,s,i),this.fileCreatedForTest(n,a),this.savingForOverrides.delete(e)}fileCreatedForTest(e,t){}patternForFileSystemUISourceCode(e){const t=Re.relativePath(e);return t.length<2?"":"longurls"===t[1]&&2!==t.length?"http?://"+t[0]+"/*":"http?://"+this.decodeLocalPathToUrlPath(this.decodeLocalPathToUrlPath(t.join("/")))}async onUISourceCodeAdded(e){await this.networkUISourceCodeAdded(e),await this.filesystemUISourceCodeAdded(e)}canHandleNetworkUISourceCode(e){return this.activeInternal&&!e.url().startsWith("snippet://")}async networkUISourceCodeAdded(e){if(e.project().type()!==j.Network||!this.canHandleNetworkUISourceCode(e))return;const n=t.urlWithoutHash(e.url());this.networkUISourceCodeForEncodedPath.set(this.encodedPathFromUrl(n),e);const s=this.projectInternal.uiSourceCodeForURL(this.fileUrlFromNetworkUrl(n));s&&await this.bind(e,s)}async filesystemUISourceCodeAdded(e){if(!this.activeInternal||e.project()!==this.projectInternal)return;this.updateInterceptionPatterns();const n=Re.relativePath(e),s=this.networkUISourceCodeForEncodedPath.get(t.join(n,"/"));s&&await this.bind(s,e)}async generateHeaderPatterns(e){const t=new Set,n=(await e.requestContent()).content||"[]";let s=[];try{if(s=JSON.parse(n),!s.every(qe))throw"Type mismatch after parsing"}catch(n){return console.error("Failed to parse",e.url(),"for locally overriding headers."),{headerPatterns:t,path:I,overridesWithRegex:[]}}const i=Re.relativePath(e).join("/"),r=this.decodeLocalPathToUrlPath(i).slice(0,-Oe.length),o=this.decodeLocalPathToUrlPath(r),a=[];for(const e of s){t.add("http?://"+o+e.applyTo);const{head:n,tail:s}=De(e.applyTo);if(s){t.add("http?://"+o+n);const i=He(o+n)+"("+He(s)+")?",r=new RegExp("^https?://"+i+"$");a.push({applyToRegex:r,headers:e.headers})}else{const t=new RegExp("^https?://"+He(o+e.applyTo)+"$");a.push({applyToRegex:t,headers:e.headers})}}return{headerPatterns:t,path:r,overridesWithRegex:a}}async updateInterceptionPatternsForTests(){await this.#t()}updateInterceptionPatterns(){this.updateInterceptionThrottler.schedule(this.#t.bind(this))}async#t(){if(this.#e.clear(),!this.activeInternal||!this.projectInternal)return E.instance().setInterceptionHandlerForPatterns([],this.interceptionHandlerBound);let e=new Set;for(const t of this.projectInternal.uiSourceCodes()){const n=this.patternForFileSystemUISourceCode(t);if(_.isEnabled(q.HEADER_OVERRIDES)&&t.name()===Oe){const{headerPatterns:n,path:s,overridesWithRegex:i}=await this.generateHeaderPatterns(t);n.size>0&&(e=new Set([...e,...n]),this.#e.set(s,i))}else e.add(n);const{head:s,tail:i}=De(n);i&&e.add(s)}return E.instance().setInterceptionHandlerForPatterns(Array.from(e).map((e=>({urlPattern:e,requestStage:"Response"}))),this.interceptionHandlerBound)}async onUISourceCodeRemoved(e){await this.networkUISourceCodeRemoved(e),await this.filesystemUISourceCodeRemoved(e)}async networkUISourceCodeRemoved(e){e.project().type()===j.Network&&(await this.unbind(e),this.networkUISourceCodeForEncodedPath.delete(this.encodedPathFromUrl(e.url())))}async filesystemUISourceCodeRemoved(e){e.project()===this.projectInternal&&(this.updateInterceptionPatterns(),this.originalResponseContentPromises.delete(e),await this.unbind(e))}async setProject(e){e!==this.projectInternal&&(this.projectInternal&&await Promise.all(this.projectInternal.uiSourceCodes().map((e=>this.filesystemUISourceCodeRemoved(e)))),this.projectInternal=e,this.projectInternal&&await Promise.all(this.projectInternal.uiSourceCodes().map((e=>this.filesystemUISourceCodeAdded(e)))),await this.updateActiveProject(),this.dispatchEventToListeners(_e.ProjectChanged,this.projectInternal))}async onProjectAdded(e){if(e.type()!==j.FileSystem||"overrides"!==Re.fileSystemType(e))return;Re.fileSystemPath(e.id())&&(this.projectInternal&&this.projectInternal.remove(),await this.setProject(e))}async onProjectRemoved(e){e===this.projectInternal&&await this.setProject(null)}mergeHeaders(e,t){const n=[],s=new Map;for(const t of e)s.set(t.name,t.value);for(const[e,n]of Object.entries(t))s.set(e,n);return s.forEach(((e,t)=>{n.push({name:t,value:e})})),n}#n(e,t,n){const s=this.#e.get(e)||[];for(const e of s)e.applyToRegex.test(t)&&(n=this.mergeHeaders(n,e.headers));return n}handleHeaderInterception(e){let n=e.responseHeaders||[];const s=this.rawPathFromUrl(e.request.url).split("/");let i=I;n=this.#n(i,e.request.url,n);for(const r of s)i=t.concatenate(i,r,"/"),n=this.#n(i,e.request.url,n);return n}async interceptionHandler(e){const t=e.request.method;if(!this.activeInternal||"GET"!==t&&"POST"!==t)return;const i=this.projectInternal,r=this.fileUrlFromNetworkUrl(e.request.url),o=i.uiSourceCodeForURL(r);let a=[];if(_.isEnabled(q.HEADER_OVERRIDES)&&(a=this.handleHeaderInterception(e)),!o&&!a.length)return;a.length||(a=e.responseHeaders||[]);let d="";if(e.responseHeaders)for(const t of e.responseHeaders)if("content-type"===t.name.toLowerCase()){d=t.value;break}if(!d){const t=s[e.resourceType]||s.Other;d=o?.mimeType()||"",n.fromMimeType(d)!==t&&(d=t.canonicalMimeType())}if(o){this.originalResponseContentPromises.set(o,e.responseBody().then((e=>{if(e.error||null===e.content)return null;if(e.encoded){const t=atob(e.content),n=new Uint8Array(t.length);for(let e=0;e<t.length;++e)n[e]=t.charCodeAt(e);return new TextDecoder("utf-8").decode(n)}return e.content})));const t=o.project(),n=await t.requestFileBlob(o);n&&e.continueRequestWithContent(new Blob([n],{type:d}),!1,a)}else{const t=await e.responseBody();!t.error&&t.content&&e.continueRequestWithContent(new Blob([t.content],{type:d}),!0,a)}}}const Ne=new Set(["con","prn","aux","nul","com1","com2","com3","com4","com5","com6","com7","com8","com9","lpt1","lpt2","lpt3","lpt4","lpt5","lpt6","lpt7","lpt8","lpt9"]),Oe=".headers";var _e;function qe(e){return!!(e&&e.applyTo&&(e.applyTo,1)&&e.headers&&Object.keys(e.headers).length)&&Object.values(e.headers).every((e=>"string"==typeof e))}function He(e){return x(e,"[]{}()\\.^$+|-,?").replaceAll("*",".*")}function De(e){const t=e.lastIndexOf("/"),n=t>=0?e.slice(t+1):e,s=t>=0?e.slice(0,t+1):"",i=new RegExp("^"+He(n)+"$");return i.test("index.html")||i.test("index.htm")||i.test("index.php")?{head:s,tail:n}:{head:e}}(_e||(_e={})).ProjectChanged="ProjectChanged";var $e=Object.freeze({__proto__:null,NetworkPersistenceManager:We,HEADERS_FILENAME:Oe,get Events(){return _e},isHeaderOverride:qe,escapeRegex:He,extractDirectoryIndex:De});const ze={linkedToSourceMapS:"Linked to source map: {PH1}",linkedToS:"Linked to {PH1}"},Ve=D("models/persistence/PersistenceUtils.ts",ze),Ge=$.bind(void 0,Ve);class Je{static tooltipForUISourceCode(e){const t=Xe.instance().binding(e);return t?e===t.network?Re.tooltipForUISourceCode(t.fileSystem):t.network.contentType().isFromSourceMap()?Ge(ze.linkedToSourceMapS,{PH1:y(t.network.url(),150)}):Ge(ze.linkedToS,{PH1:y(t.network.url(),150)}):""}static iconForUISourceCode(e){const t=Xe.instance().binding(e);if(t){if(!t.fileSystem.url().startsWith("file://"))return null;const e=G.create("mediumicon-file-sync");return J.install(e,Je.tooltipForUISourceCode(t.network)),We.instance().project()===t.fileSystem.project()&&e.classList.add("purple-dot"),e}if(e.project().type()!==j.FileSystem||!e.url().startsWith("file://"))return null;const n=G.create("mediumicon-file");return J.install(n,Je.tooltipForUISourceCode(e)),n}}class Ye extends i{constructor(e){super(),e.addEventListener(at.BindingCreated,this.bindingChanged,this),e.addEventListener(at.BindingRemoved,this.bindingChanged,this)}bindingChanged(e){const t=e.data;this.dispatchEventToListeners(z.Events.LinkIconChanged,t.network)}linkIcon(e){return Je.iconForUISourceCode(e)}}var Ke=Object.freeze({__proto__:null,PersistenceUtils:Je,LinkDecorator:Ye});let Qe;class Xe extends i{workspace;breakpointManager;filePathPrefixesToBindingCount;subscribedBindingEventListeners;mapping;constructor(e,t){super(),this.workspace=e,this.breakpointManager=t,this.filePathPrefixesToBindingCount=new Ze,this.subscribedBindingEventListeners=new w;const n=new Ye(this);V.setLinkDecorator(n),this.mapping=new ht(this.workspace,this.onStatusAdded.bind(this),this.onStatusRemoved.bind(this))}static instance(e={forceNew:null,workspace:null,breakpointManager:null}){const{forceNew:t,workspace:n,breakpointManager:s}=e;if(!Qe||t){if(!n||!s)throw new Error("Missing arguments for workspace");Qe=new Xe(n,s)}return Qe}addNetworkInterceptor(e){this.mapping.addNetworkInterceptor(e)}refreshAutomapping(){this.mapping.scheduleRemap()}async addBinding(e){await this.innerAddBinding(e)}async addBindingForTest(e){await this.innerAddBinding(e)}async removeBinding(e){await this.innerRemoveBinding(e)}async removeBindingForTest(e){await this.innerRemoveBinding(e)}async innerAddBinding(e){et.set(e.network,e),et.set(e.fileSystem,e),e.fileSystem.forceLoadOnCheckContent(),e.network.addEventListener(W.WorkingCopyCommitted,this.onWorkingCopyCommitted,this),e.fileSystem.addEventListener(W.WorkingCopyCommitted,this.onWorkingCopyCommitted,this),e.network.addEventListener(W.WorkingCopyChanged,this.onWorkingCopyChanged,this),e.fileSystem.addEventListener(W.WorkingCopyChanged,this.onWorkingCopyChanged,this),this.filePathPrefixesToBindingCount.add(e.fileSystem.url()),await this.moveBreakpoints(e.fileSystem,e.network),console.assert(!e.fileSystem.isDirty()||!e.network.isDirty()),e.fileSystem.isDirty()?this.syncWorkingCopy(e.fileSystem):e.network.isDirty()?this.syncWorkingCopy(e.network):e.network.hasCommits()&&e.network.content()!==e.fileSystem.content()&&(e.network.setWorkingCopy(e.network.content()),this.syncWorkingCopy(e.network)),this.notifyBindingEvent(e.network),this.notifyBindingEvent(e.fileSystem),this.dispatchEventToListeners(at.BindingCreated,e)}async innerRemoveBinding(e){et.get(e.network)===e&&(console.assert(et.get(e.network)===et.get(e.fileSystem),"ERROR: inconsistent binding for networkURL "+e.network.url()),et.delete(e.network),et.delete(e.fileSystem),e.network.removeEventListener(W.WorkingCopyCommitted,this.onWorkingCopyCommitted,this),e.fileSystem.removeEventListener(W.WorkingCopyCommitted,this.onWorkingCopyCommitted,this),e.network.removeEventListener(W.WorkingCopyChanged,this.onWorkingCopyChanged,this),e.fileSystem.removeEventListener(W.WorkingCopyChanged,this.onWorkingCopyChanged,this),this.filePathPrefixesToBindingCount.remove(e.fileSystem.url()),await this.breakpointManager.copyBreakpoints(e.network.url(),e.fileSystem),this.notifyBindingEvent(e.network),this.notifyBindingEvent(e.fileSystem),this.dispatchEventToListeners(at.BindingRemoved,e))}async onStatusAdded(e){const t=new lt(e.network,e.fileSystem);tt.set(e,t),await this.innerAddBinding(t)}async onStatusRemoved(e){const t=tt.get(e);await this.innerRemoveBinding(t)}onWorkingCopyChanged(e){const t=e.data;this.syncWorkingCopy(t)}syncWorkingCopy(e){const t=et.get(e);if(!t||st.has(t))return;const n=t.network===e?t.fileSystem:t.network;if(!e.isDirty())return st.add(t),n.resetWorkingCopy(),st.delete(t),void this.contentSyncedForTest();const s=R.targetForUISourceCode(t.network);if(s&&s.type()===U.Node){const t=e.workingCopy();n.requestContent().then((()=>{const e=Xe.rewrapNodeJSContent(n,n.workingCopy(),t);i.call(this,(()=>e))}))}else i.call(this,(()=>e.workingCopy()));function i(e){t&&st.add(t),n.setWorkingCopyGetter(e),t&&st.delete(t),this.contentSyncedForTest()}}onWorkingCopyCommitted(e){const t=e.data.uiSourceCode,n=e.data.content;this.syncContent(t,n,Boolean(e.data.encoded))}syncContent(e,t,n){const s=et.get(e);if(!s||nt.has(s))return;const i=s.network===e?s.fileSystem:s.network,r=R.targetForUISourceCode(s.network);function o(e){s&&nt.add(s),i.setContent(e,n),s&&nt.delete(s),this.contentSyncedForTest()}r&&r.type()===U.Node?i.requestContent().then((e=>{const n=Xe.rewrapNodeJSContent(i,e.content||"",t);o.call(this,n)})):o.call(this,t)}static rewrapNodeJSContent(e,t,n){return e.project().type()===j.FileSystem?(n.startsWith(it)&&n.endsWith(rt)&&(n=n.substring(it.length,n.length-rt.length)),t.startsWith(ot)&&(n=ot+n)):(n.startsWith(ot)&&(n=n.substring(ot.length)),t.startsWith(it)&&t.endsWith(rt)&&(n=it+n+rt)),n}contentSyncedForTest(){}async moveBreakpoints(e,t){const n=this.breakpointManager.breakpointLocationsForUISourceCode(e).map((e=>e.breakpoint));await Promise.all(n.map((async e=>(await e.remove(!1),this.breakpointManager.setBreakpoint(t,e.lineNumber(),e.columnNumber(),e.condition(),e.enabled())))))}hasUnsavedCommittedChanges(e){return!this.workspace.hasResourceContentTrackingExtensions()&&(!e.project().canSetFileContent()&&(!et.has(e)&&Boolean(e.hasCommits())))}binding(e){return et.get(e)||null}subscribeForBindingEvent(e,t){this.subscribedBindingEventListeners.set(e,t)}unsubscribeFromBindingEvent(e,t){this.subscribedBindingEventListeners.delete(e,t)}notifyBindingEvent(e){if(!this.subscribedBindingEventListeners.has(e))return;const t=Array.from(this.subscribedBindingEventListeners.get(e));for(const e of t)e.call(null)}fileSystem(e){const t=this.binding(e);return t?t.fileSystem:null}network(e){const t=this.binding(e);return t?t.network:null}filePathHasBindings(e){return this.filePathPrefixesToBindingCount.hasBindingPrefix(e)}}class Ze{prefixCounts;constructor(){this.prefixCounts=new Map}getPlatformCanonicalFilePath(e){return u()?t.toLowerCase(e):e}add(e){e=this.getPlatformCanonicalFilePath(e);let t="";for(const n of e.split("/")){t+=n+"/";const e=this.prefixCounts.get(t)||0;this.prefixCounts.set(t,e+1)}}remove(e){e=this.getPlatformCanonicalFilePath(e);let t="";for(const n of e.split("/")){t+=n+"/";const e=this.prefixCounts.get(t);1===e?this.prefixCounts.delete(t):void 0!==e&&this.prefixCounts.set(t,e-1)}}hasBindingPrefix(e){return(e=this.getPlatformCanonicalFilePath(e)).endsWith("/")||(e=t.concatenate(e,"/")),this.prefixCounts.has(e)}}const et=new WeakMap,tt=new WeakMap,nt=new WeakSet,st=new WeakSet,it="(function (exports, require, module, __filename, __dirname) { ",rt="\n});",ot="#!/usr/bin/env node";var at;!function(e){e.BindingCreated="BindingCreated",e.BindingRemoved="BindingRemoved"}(at||(at={}));class dt{encoder;constructor(){this.encoder=new d}encode(e){return e.split("/").map((e=>this.encoder.toChar(e))).join("")}decode(e){return e.split("").map((e=>this.encoder.fromChar(e))).join("/")}}class lt{network;fileSystem;constructor(e,t){this.network=e,this.fileSystem=t}}var ct=Object.freeze({__proto__:null,PersistenceImpl:Xe,NodePrefix:it,NodeSuffix:rt,NodeShebang:ot,get Events(){return at},PathEncoder:dt,PersistenceBinding:lt});class ht{workspace;onStatusAdded;onStatusRemoved;statuses;fileSystemUISourceCodes;sweepThrottler;sourceCodeToProcessingPromiseMap;sourceCodeToAutoMappingStatusMap;sourceCodeToMetadataMap;filesIndex;projectFoldersIndex;activeFoldersIndex;interceptors;constructor(e,t,n){this.workspace=e,this.onStatusAdded=t,this.onStatusRemoved=n,this.statuses=new Set,this.fileSystemUISourceCodes=new pt,this.sweepThrottler=new a(100),this.sourceCodeToProcessingPromiseMap=new WeakMap,this.sourceCodeToAutoMappingStatusMap=new WeakMap,this.sourceCodeToMetadataMap=new WeakMap;const s=new dt;this.filesIndex=new ut(s),this.projectFoldersIndex=new mt(s),this.activeFoldersIndex=new mt(s),this.interceptors=[],this.workspace.addEventListener(A.UISourceCodeAdded,(e=>this.onUISourceCodeAdded(e.data))),this.workspace.addEventListener(A.UISourceCodeRemoved,(e=>this.onUISourceCodeRemoved(e.data))),this.workspace.addEventListener(A.UISourceCodeRenamed,this.onUISourceCodeRenamed,this),this.workspace.addEventListener(A.ProjectAdded,(e=>this.onProjectAdded(e.data)),this),this.workspace.addEventListener(A.ProjectRemoved,(e=>this.onProjectRemoved(e.data)),this);for(const t of e.projects())this.onProjectAdded(t);for(const t of e.uiSourceCodes())this.onUISourceCodeAdded(t)}addNetworkInterceptor(e){this.interceptors.push(e),this.scheduleRemap()}scheduleRemap(){for(const e of this.statuses.values())this.clearNetworkStatus(e.network);this.scheduleSweep()}scheduleSweep(){this.sweepThrottler.schedule(function(){const e=this.workspace.projectsForType(j.Network);for(const t of e)for(const e of t.uiSourceCodes())this.computeNetworkStatus(e);return this.onSweepHappenedForTest(),Promise.resolve()}.bind(this))}onSweepHappenedForTest(){}onProjectRemoved(e){for(const t of e.uiSourceCodes())this.onUISourceCodeRemoved(t);if(e.type()!==j.FileSystem)return;const t=e;for(const e of t.initialGitFolders())this.projectFoldersIndex.removeFolder(e);this.projectFoldersIndex.removeFolder(t.fileSystemPath()),this.scheduleRemap()}onProjectAdded(e){if(e.type()!==j.FileSystem)return;const t=e;for(const e of t.initialGitFolders())this.projectFoldersIndex.addFolder(e);this.projectFoldersIndex.addFolder(t.fileSystemPath()),e.uiSourceCodes().forEach(this.onUISourceCodeAdded.bind(this)),this.scheduleRemap()}onUISourceCodeAdded(e){const t=e.project();if(t.type()===j.FileSystem){if(!Re.fileSystemSupportsAutomapping(t))return;this.filesIndex.addPath(e.url()),this.fileSystemUISourceCodes.add(e),this.scheduleSweep()}else t.type()===j.Network&&this.computeNetworkStatus(e)}onUISourceCodeRemoved(e){if(e.project().type()===j.FileSystem){this.filesIndex.removePath(e.url()),this.fileSystemUISourceCodes.delete(e.url());const t=this.sourceCodeToAutoMappingStatusMap.get(e);t&&this.clearNetworkStatus(t.network)}else e.project().type()===j.Network&&this.clearNetworkStatus(e)}onUISourceCodeRenamed(e){const{uiSourceCode:t,oldURL:n}=e.data;if(t.project().type()!==j.FileSystem)return;this.filesIndex.removePath(n),this.fileSystemUISourceCodes.delete(n);const s=this.sourceCodeToAutoMappingStatusMap.get(t);s&&this.clearNetworkStatus(s.network),this.filesIndex.addPath(t.url()),this.fileSystemUISourceCodes.add(t),this.scheduleSweep()}computeNetworkStatus(e){if(this.sourceCodeToProcessingPromiseMap.has(e)||this.sourceCodeToAutoMappingStatusMap.has(e))return;if(this.interceptors.some((t=>t(e))))return;if(e.url().startsWith("wasm://"))return;const t=this.createBinding(e).then(async function(n){if(!n)return null;if(this.sourceCodeToProcessingPromiseMap.get(e)!==t)return null;if(n.network.contentType().isFromSourceMap()||!n.fileSystem.contentType().isTextType())return n;if(n.fileSystem.isDirty()&&(n.network.isDirty()||n.network.hasCommits()))return null;const[s,i]=await Promise.all([n.fileSystem.requestContent(),n.network.project().requestFileContent(n.network)]);if(null===s.content||null===i)return null;if(this.sourceCodeToProcessingPromiseMap.get(e)!==t)return null;const r=R.targetForUISourceCode(n.network);let o=!1;const a=s.content;if(r&&r.type()===U.Node){if(i.content){const e=Xe.rewrapNodeJSContent(n.fileSystem,a,i.content);o=a===e}}else i.content&&(o=a.trimRight()===i.content.trimRight());if(!o)return this.prevalidationFailedForTest(n),null;return n}.bind(this)).then(function(n){if(this.sourceCodeToProcessingPromiseMap.get(e)!==t)return;if(this.sourceCodeToProcessingPromiseMap.delete(e),!n)return void this.onBindingFailedForTest();if(this.sourceCodeToAutoMappingStatusMap.has(n.network)||this.sourceCodeToAutoMappingStatusMap.has(n.fileSystem))return;if(this.statuses.add(n),this.sourceCodeToAutoMappingStatusMap.set(n.network,n),this.sourceCodeToAutoMappingStatusMap.set(n.fileSystem,n),n.exactMatch){const e=this.projectFoldersIndex.closestParentFolder(n.fileSystem.url());!!e&&this.activeFoldersIndex.addFolder(e)&&this.scheduleSweep()}this.onStatusAdded.call(null,n)}.bind(this));this.sourceCodeToProcessingPromiseMap.set(e,t)}prevalidationFailedForTest(e){}onBindingFailedForTest(){}clearNetworkStatus(e){if(this.sourceCodeToProcessingPromiseMap.has(e))return void this.sourceCodeToProcessingPromiseMap.delete(e);const t=this.sourceCodeToAutoMappingStatusMap.get(e);if(t){if(this.statuses.delete(t),this.sourceCodeToAutoMappingStatusMap.delete(t.network),this.sourceCodeToAutoMappingStatusMap.delete(t.fileSystem),t.exactMatch){const e=this.projectFoldersIndex.closestParentFolder(t.fileSystem.url());e&&this.activeFoldersIndex.removeFolder(e)}this.onStatusRemoved.call(null,t)}}createBinding(e){const n=e.url();if(n.startsWith("file://")||n.startsWith("snippet://")){const t=this.fileSystemUISourceCodes.get(n),s=t?new ft(e,t,!1):null;return Promise.resolve(s)}let s=t.extractPath(n);if(null===s)return Promise.resolve(null);s.endsWith("/")&&(s=t.concatenate(s,"index.html"));const i=this.filesIndex.similarFiles(s).map((e=>this.fileSystemUISourceCodes.get(e)));return i.length?this.pullMetadatas(i.concat(e)).then(function(){const t=i.filter((e=>Boolean(e)&&Boolean(this.activeFoldersIndex.closestParentFolder(e.url())))),n=this.sourceCodeToMetadataMap.get(e);if(!n||!n.modificationTime&&"number"!=typeof n.contentSize)return 1!==t.length?null:new ft(e,t[0],!1);let s=this.filterWithMetadata(t,n);s.length||(s=this.filterWithMetadata(i,n));if(1!==s.length)return null;return new ft(e,s[0],!0)}.bind(this)):Promise.resolve(null)}async pullMetadatas(e){await Promise.all(e.map((async e=>{this.sourceCodeToMetadataMap.set(e,await e.requestMetadata())})))}filterWithMetadata(e,t){return e.filter((e=>{const n=this.sourceCodeToMetadataMap.get(e);if(!n)return!1;const s=!t.modificationTime||!n.modificationTime||Math.abs(t.modificationTime.getTime()-n.modificationTime.getTime())<1e3,i=!t.contentSize||n.contentSize===t.contentSize;return s&&i}))}}class ut{encoder;reversedIndex;constructor(e){this.encoder=e,this.reversedIndex=new l}addPath(e){const t=this.encoder.encode(e);this.reversedIndex.add(b(t))}removePath(e){const t=this.encoder.encode(e);this.reversedIndex.remove(b(t))}similarFiles(e){const t=this.encoder.encode(e),n=b(t),s=this.reversedIndex.longestPrefix(n,!1);return s?this.reversedIndex.words(s).map((e=>this.encoder.decode(b(e)))):[]}}class mt{encoder;index;folderCount;constructor(e){this.encoder=e,this.index=new l,this.folderCount=new Map}addFolder(e){e.endsWith("/")&&(e=t.substring(e,0,e.length-1));const n=this.encoder.encode(e);this.index.add(n);const s=this.folderCount.get(n)||0;return this.folderCount.set(n,s+1),0===s}removeFolder(e){e.endsWith("/")&&(e=t.substring(e,0,e.length-1));const n=this.encoder.encode(e),s=this.folderCount.get(n)||0;return!!s&&(s>1?(this.folderCount.set(n,s-1),!1):(this.index.remove(n),this.folderCount.delete(n),!0))}closestParentFolder(e){const t=this.encoder.encode(e),n=this.index.longestPrefix(t,!0);return this.encoder.decode(n)}}class pt{sourceCodes;constructor(){this.sourceCodes=new Map}getPlatformCanonicalFileUrl(e){return u()?t.toLowerCase(e):e}add(e){const t=this.getPlatformCanonicalFileUrl(e.url());this.sourceCodes.set(t,e)}get(e){return e=this.getPlatformCanonicalFileUrl(e),this.sourceCodes.get(e)}delete(e){e=this.getPlatformCanonicalFileUrl(e),this.sourceCodes.delete(e)}}class ft{network;fileSystem;exactMatch;constructor(e,t,n){this.network=e,this.fileSystem=t,this.exactMatch=n}}var gt=Object.freeze({__proto__:null,Automapping:ht,AutomappingStatus:ft});const St=new CSSStyleSheet;St.replaceSync("/*\n * Copyright 2015 The Chromium Authors. All rights reserved.\n * Use of this source code is governed by a BSD-style license that can be\n * found in the LICENSE file.\n */\n\n.file-system-header {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  flex: auto;\n  margin: 10px 0;\n}\n\n.file-system-header-text {\n  flex: 1 0 auto;\n}\n\n.add-button {\n  margin-left: 10px;\n  align-self: flex-start;\n}\n\n.file-system-list {\n  flex: auto;\n}\n\n.file-system-list-empty {\n  flex: auto;\n  height: 30px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  text-align: center;\n}\n\n.file-system-list-item {\n  padding: 3px 5px;\n  height: 30px;\n  display: flex;\n  align-items: center;\n  flex: auto 1 1;\n}\n\n.file-system-value {\n  flex: 1 1 0;\n}\n\n.list-item .file-system-value {\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  user-select: none;\n  overflow: hidden;\n}\n\n.file-system-edit-row {\n  flex: none;\n  display: flex;\n  flex-direction: row;\n  margin: 6px 5px;\n  align-items: center;\n}\n\n.file-system-edit-row input {\n  width: 100%;\n  text-align: inherit;\n}\n\n");const yt={excludedFolders:"Excluded folders",add:"Add",none:"None",sViaDevtools:"{PH1} (via .devtools)",folderPath:"Folder path",enterAPath:"Enter a path",enterAUniquePath:"Enter a unique path"},wt=D("models/persistence/EditFileSystemView.ts",yt),Ft=$.bind(void 0,wt);class vt extends Y{fileSystemPath;excludedFolders;eventListeners;excludedFoldersList;muteUpdate;excludedFolderEditor;constructor(e){super(!0),this.fileSystemPath=e,this.excludedFolders=[],this.eventListeners=[be.instance().addEventListener(ke.ExcludedFolderAdded,this.update,this),be.instance().addEventListener(ke.ExcludedFolderRemoved,this.update,this)];const t=this.contentElement.createChild("div","file-system-header");t.createChild("div","file-system-header-text").textContent=Ft(yt.excludedFolders),t.appendChild(K(Ft(yt.add),this.addExcludedFolderButtonClicked.bind(this),"add-button")),this.excludedFoldersList=new Q(this),this.excludedFoldersList.element.classList.add("file-system-list");const n=document.createElement("div");n.classList.add("file-system-list-empty"),n.textContent=Ft(yt.none),this.excludedFoldersList.setEmptyPlaceholder(n),this.excludedFoldersList.show(this.contentElement),this.update()}dispose(){o(this.eventListeners)}getFileSystem(){return be.instance().fileSystem(this.fileSystemPath)}update(){if(!this.muteUpdate){this.excludedFoldersList.clear(),this.excludedFolders=[];for(const e of this.getFileSystem().excludedFolders().values())this.excludedFolders.push(e),this.excludedFoldersList.appendItem(e,!0)}}addExcludedFolderButtonClicked(){this.excludedFoldersList.addNewItem(0,"")}renderItem(e,t){const n=document.createElement("div");n.classList.add("file-system-list-item");const s=t?e:Ft(yt.sViaDevtools,{PH1:e}),i=n.createChild("div","file-system-value");return i.textContent=s,J.install(i,s),n}removeItemRequested(e,t){this.getFileSystem().removeExcludedFolder(this.excludedFolders[t])}commitEdit(e,t,n){this.muteUpdate=!0,n||this.getFileSystem().removeExcludedFolder(e),this.getFileSystem().addExcludedFolder(this.normalizePrefix(t.control("pathPrefix").value)),this.muteUpdate=!1,this.update()}beginEdit(e){const t=this.createExcludedFolderEditor();return t.control("pathPrefix").value=e,t}createExcludedFolderEditor(){if(this.excludedFolderEditor)return this.excludedFolderEditor;const e=new X;this.excludedFolderEditor=e;const t=e.contentElement();t.createChild("div","file-system-edit-row").createChild("div","file-system-value").textContent=Ft(yt.folderPath);return t.createChild("div","file-system-edit-row").createChild("div","file-system-value").appendChild(e.createInput("pathPrefix","text","/path/to/folder/",function(e,t,n){const s=this.normalizePrefix(n.value.trim());if(!s)return{valid:!1,errorMessage:Ft(yt.enterAPath)};const i=this.getFileSystem().excludedFolders().size;for(let e=0;e<i;++e)if(e!==t&&this.excludedFolders[e]===s)return{valid:!1,errorMessage:Ft(yt.enterAUniquePath)};return{valid:!0,errorMessage:void 0}}.bind(this))),e}normalizePrefix(e){return e?e+("/"===e[e.length-1]?"":"/"):""}wasShown(){super.wasShown(),this.excludedFoldersList.registerCSSFiles([St]),this.registerCSSFiles([St])}}var Ct=Object.freeze({__proto__:null,EditFileSystemView:vt});const Pt={saveAs:"Save as...",saveImage:"Save image",saveForOverrides:"Save for overrides",openInContainingFolder:"Open in containing folder"},It=D("models/persistence/PersistenceActions.ts",Pt),xt=$.bind(void 0,It);let bt;class kt{static instance(e={forceNew:null}){const{forceNew:t}=e;return bt&&!t||(bt=new kt),bt}appendApplicableItems(e,n,s){const i=s;i.contentType().isDocumentOrScriptOrStyleSheet()?n.saveSection().appendItem(xt(Pt.saveAs),(async function(){i instanceof N&&i.commitWorkingCopy();let e=(await i.requestContent()).content||"";await i.contentEncoded()&&(e=window.atob(e));const t=i.contentURL();O.instance().save(t,e,!0),O.instance().close(t)})):i instanceof T&&i.contentType().isImage()&&n.saveSection().appendItem(xt(Pt.saveImage),(async function(){const e=i,t=(await e.requestContent()).content||"",n=document.createElement("a");n.download=e.displayName,n.href="data:"+e.mimeType+";base64,"+t,n.click()}));const r=B.instance().uiSourceCodeForURL(i.contentURL());r&&We.instance().canSaveUISourceCodeForOverrides(r)&&n.saveSection().appendItem(xt(Pt.saveForOverrides),(()=>{r.commitWorkingCopy(),We.instance().saveUISourceCodeForOverrides(r),c(r)}));const o=r&&Xe.instance().binding(r),a=o?o.fileSystem.contentURL():i.contentURL();if(a.startsWith("file://")){const e=t.urlToRawPathString(a,u());n.revealSection().appendItem(xt(Pt.openInContainingFolder),(()=>h.showItemInFolder(e)))}}}var Et=Object.freeze({__proto__:null,ContextMenuProvider:kt});const Ut=new CSSStyleSheet;Ut.replaceSync('/*\n * Copyright 2017 The Chromium Authors. All rights reserved.\n * Use of this source code is governed by a BSD-style license that can be\n * found in the LICENSE file.\n */\n\n.workspace-settings-tab header {\n  padding: 0 0 6px;\n}\n\n.workspace-settings-tab header > h1 {\n  font-size: 18px;\n  font-weight: normal;\n  margin: 0;\n  padding-bottom: 3px;\n}\n\n.workspace-settings-tab .settings-content {\n  overflow-y: auto;\n  overflow-x: hidden;\n  margin: 8px 8px 8px 0;\n  padding: 0 4px;\n  flex: auto;\n}\n\n.workspace-settings-tab .settings-container {\n  width: 100%;\n  column-width: 288px;\n}\n\n.workspace-settings-tab .settings-tab.settings-container {\n  column-width: 308px;\n}\n\n.workspace-settings-tab .settings-container-wrapper {\n  position: absolute;\n  top: 31px;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  overflow: auto;\n  padding-top: 9px;\n}\n\n.workspace-settings-tab .settings-tab.settings-content {\n  margin: 0;\n  padding: 0;\n}\n\n.workspace-settings-tab .settings-tab p {\n  margin: 12px 0;\n}\n\n.workspace-settings-tab p.folder-exclude-pattern {\n  display: grid;\n  align-items: center;\n}\n\n.workspace-settings-tab p.folder-exclude-pattern > input {\n  width: 80%;\n  margin-left: 10px;\n}\n\n.workspace-settings-tab .settings-tab .file-system-container {\n  border-top: 1px solid var(--color-background-elevation-2);\n  padding: 19px 0 10px;\n  margin: 20px 0;\n}\n\n.workspace-settings-tab .settings-tab .file-system-header {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n}\n\n.workspace-settings-tab .settings-tab .file-system-name {\n  font-weight: bold;\n  flex: none;\n  margin-right: 10px;\n  font-size: 15px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  max-width: 70%;\n}\n\n.workspace-settings-tab .settings-tab .file-system-path {\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  flex: auto;\n}\n\n.workspace-settings-tab .settings-info-message {\n  background-color: var(--color-background-elevation-1);\n  padding: 10px;\n  margin: 20px 0;\n}\n\n.workspace-settings-tab .settings-tab.settings-content.settings-container {\n  column-width: initial;\n  overflow: hidden;\n  padding-right: 10px;\n}\n/*\n * Always show an outline. Needed because we have a white background here.\n */\n\n.workspace-settings-tab .harmony-input[type="text"]:not(.error-input):not(:invalid) {\n  box-shadow: var(--legacy-focus-ring-inactive-shadow);\n}\n\n');const Tt={},Rt={workspace:"Workspace",mappingsAreInferredAutomatically:"Mappings are inferred automatically.",addFolder:"Add folder…",folderExcludePattern:"Folder exclude pattern",remove:"Remove"},Lt=D("models/persistence/WorkspaceSettingsTab.ts",Rt),jt=$.bind(void 0,Lt);let Mt;class At extends Y{containerElement;fileSystemsListContainer;elementByPath;mappingViewByPath;constructor(){super(),this.element.classList.add("workspace-settings-tab");const e=this.element.createChild("header");Z(e.createChild("h1"),jt(Rt.workspace)),this.containerElement=this.element.createChild("div","settings-container-wrapper").createChild("div","settings-tab settings-content settings-container"),be.instance().addEventListener(ke.FileSystemAdded,(e=>this.fileSystemAdded(e.data)),this),be.instance().addEventListener(ke.FileSystemRemoved,(e=>this.fileSystemRemoved(e.data)),this);const t=this.createFolderExcludePatternInput();t.classList.add("folder-exclude-pattern"),this.containerElement.appendChild(t);const n=this.containerElement.createChild("div","settings-info-message");Z(n,jt(Rt.mappingsAreInferredAutomatically)),this.fileSystemsListContainer=this.containerElement.createChild("div","");const s=K(jt(Rt.addFolder),this.addFileSystemClicked.bind(this));this.containerElement.appendChild(s),this.setDefaultFocusedElement(s),this.elementByPath=new Map,this.mappingViewByPath=new Map;const i=be.instance().fileSystems();for(let e=0;e<i.length;++e)this.addItem(i[e])}static instance(e={forceNew:null}){const{forceNew:t}=e;return Mt&&!t||(Mt=new Tt.WorkspaceSettingsTab),Mt}wasShown(){super.wasShown(),this.registerCSSFiles([Ut])}createFolderExcludePatternInput(){const e=document.createElement("p"),t=e.createChild("label");t.textContent=jt(Rt.folderExcludePattern);const n=ee("","text");te(t,n),e.appendChild(n);const s=be.instance().workspaceFolderExcludePatternSetting(),i=ne(n,s.set.bind(s),(function(e){let t;try{t=new RegExp(e)}catch(e){}return{valid:Boolean(t),errorMessage:void 0}}),!1);return s.addChangeListener((()=>i.call(null,s.get()))),i(s.get()),e}addItem(e){if(!(e instanceof fe))return;const t=We.instance().project();if(t&&be.instance().fileSystem(t.fileSystemPath())===e)return;const n=this.renderFileSystem(e);this.elementByPath.set(e.path(),n),this.fileSystemsListContainer.appendChild(n);const s=new vt(e.path());this.mappingViewByPath.set(e.path(),s),s.element.classList.add("file-system-mapping-view"),s.show(n)}renderFileSystem(e){const t=e.path(),n=t.lastIndexOf("/"),s=t.substr(n+1),i=document.createElement("div");i.classList.add("file-system-container");const r=i.createChild("div","file-system-header"),o=r.createChild("div","file-system-name");o.textContent=s,se(o,2);const a=r.createChild("div","file-system-path");a.textContent=t,J.install(a,t);const d=new ie(""),l=new re(jt(Rt.remove),"largeicon-delete");return l.addEventListener(re.Events.Click,this.removeFileSystemClicked.bind(this,e)),d.appendToolbarItem(l),r.appendChild(d.element),i}removeFileSystemClicked(e){be.instance().removeFileSystem(e)}addFileSystemClicked(){be.instance().addFileSystem()}fileSystemAdded(e){this.addItem(e)}fileSystemRemoved(e){const t=this.mappingViewByPath.get(e.path());t&&(t.dispose(),this.mappingViewByPath.delete(e.path()));const n=this.elementByPath.get(e.path());n&&(this.elementByPath.delete(e.path()),n.remove())}}Tt.WorkspaceSettingsTab=At;const Bt={openSourceFilesInVSCode:"Open source files in Visual Studio Code",enableFileSync:"Save DevTools changes to disk"},Wt=D("models/persistence/WorkspaceSettingsTab_edge.ts",Bt),Nt=$.bind(void 0,Wt);class Ot extends Tt.WorkspaceSettingsTab{constructor(){if(super(),!_.isEnabled(q.EDGE_OPEN_VSCODE))return;const t=document.createElement("div");t.className="open-in-vscode",t.appendChild(oe(Nt(Bt.openSourceFilesInVSCode),e.instance().moduleSetting("openSourceFilesInVSCode")));const n=document.createElement("div");n.className="enable-file-sync",n.appendChild(oe(Nt(Bt.enableFileSync),e.instance().moduleSetting("enableFileSync")));const s=this.containerElement.childNodes[0];this.containerElement.insertBefore(t,s),this.containerElement.insertBefore(n,s)}}Tt.WorkspaceSettingsTab=Ot;var _t=Object.freeze({__proto__:null,__scope:Tt,WorkspaceSettingsTab:At}),qt=Object.freeze({__proto__:null,Automapping:gt,EditFileSystemView:Ct,FileSystemWorkspaceBinding:Ae,IsolatedFileSystem:ve,IsolatedFileSystemManager:Ue,NetworkPersistenceManager:$e,Persistence:ct,PersistenceActions:Et,PersistenceUtils:Ke,PlatformFileSystem:he,WorkspaceSettingsTab:_t});export{gt as Automapping,Ct as EditFileSystemView,at as Events,_e as Events$1,Ae as FileSystemWorkspaceBinding,Re as FileSystemWorkspaceBinding$1,Oe as HEADERS_FILENAME,ve as IsolatedFileSystem,Ue as IsolatedFileSystemManager,be as IsolatedFileSystemManager$1,$e as NetworkPersistenceManager,We as NetworkPersistenceManager$1,dt as PathEncoder,ct as Persistence,Et as PersistenceActions,Xe as PersistenceImpl,Ke as PersistenceUtils,Je as PersistenceUtils$1,he as PlatformFileSystem,ce as PlatformFileSystem$1,_t as WorkspaceSettingsTab,qe as isHeaderOverride,qt as persistence};
//# sourceMappingURL=persistence.js.map
